<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÄÄƒng Quáº£ng CÃ¡o - Tin Rao Váº·t Tháº¿ Há»‡ Má»›i</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="glass-container">
        <div class="upload-header">
            <h1>ğŸš€ ÄÄƒng Quáº£ng CÃ¡o</h1>
            <p>Hiá»‡n Ä‘áº¡i - VÄƒn minh - KhÃ´ng dÃ¡n bá»«a bÃ£i</p>
        </div>
        
        <form id="adForm">
            <div class="input-group">
                <label for="title">TiÃªu Ä‘á» quáº£ng cÃ¡o (Tá»‘i Ä‘a 30 kÃ½ tá»±)</label>
                <input type="text" id="title" maxlength="30" placeholder="VD: BÃ¡n cÄƒn há»™ chung cÆ°..." required>
                <small class="char-count" id="titleCount">0/30</small>
            </div>
            
            <div class="input-group">
                <label for="description">MÃ´ táº£ chi tiáº¿t (Tá»‘i Ä‘a 100 kÃ½ tá»±)</label>
                <textarea id="description" rows="4" maxlength="100" placeholder="Nháº­p chi tiáº¿t vá» sáº£n pháº©m hoáº·c dá»‹ch vá»¥..." required></textarea>
                <small class="char-count" id="descCount">0/100</small>
            </div>
            
            <div class="input-group">
                <label for="images">HÃ¬nh áº£nh (Tá»‘i Ä‘a 3 áº£nh)</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="images" multiple accept="image/*" required>
                    <div class="file-custom-ui">
                        <span class="icon">ğŸ“¸</span>
                        <span class="text">Chá»n áº£nh sáº£n pháº©m</span>
                        <span class="subtext">Tá»‘i Ä‘a 3 áº£nh, nÃ©n cháº¥t lÆ°á»£ng cao (~200KB)</span>
                    </div>
                </div>
                <div id="imagePreview" class="image-preview-grid"></div>
                <div class="upload-tips" style="margin-top: 15px; font-size: 0.8rem; color: var(--text-dim); background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; border: 1px dashed rgba(255,255,255,0.2);">
                    <strong>ğŸ’¡ Máº¹o Ä‘á»ƒ tin Ä‘Äƒng Ä‘áº¹p hÆ¡n:</strong>
                    <ul style="margin-top: 5px; margin-left: 15px;">
                        <li>NÃªn dÃ¹ng <b>áº£nh náº±m ngang</b> (tá»· lá»‡ 16:9).</li>
                        <li>TrÃ¡nh Ä‘á»ƒ thÃ´ng tin quan trá»ng á»Ÿ cÃ¡c gÃ³c áº£nh.</li>
                        <li>áº¢nh rÃµ nÃ©t, Ã¡nh sÃ¡ng tá»‘t sáº½ thu hÃºt ngÆ°á»i xem hÆ¡n.</li>
                    </ul>
                </div>
            </div>
            
            <button type="submit" id="submitBtn">
                <span class="btn-text">LÆ°u & ÄÄƒng Ngay</span>
                <div class="loader"></div>
            </button>
        </form>
    </div>

    <div id="toast" class="toast"></div>

    <script type="module">
        import firebaseConfig from '../js/firebase-config.js';

        // Initialize Firebase
        const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const adForm = document.getElementById('adForm');
        const imageInput = document.getElementById('images');
        const imagePreview = document.getElementById('imagePreview');
        const submitBtn = document.getElementById('submitBtn');
        const toast = document.getElementById('toast');
        const titleInput = document.getElementById('title');
        const descInput = document.getElementById('description');

        titleInput.addEventListener('input', () => {
            document.getElementById('titleCount').textContent = `${titleInput.value.length}/30`;
        });

        descInput.addEventListener('input', () => {
            document.getElementById('descCount').textContent = `${descInput.value.length}/100`;
        });

        let compressedBase64Images = [];

        imageInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 3) {
                showToast('Tá»‘i Ä‘a lÃ  3 áº£nh', 'error');
                imageInput.value = '';
                imagePreview.innerHTML = '';
                return;
            }
            if (files.length === 0) return;

            imagePreview.innerHTML = '';
            compressedBase64Images = [];
            
            for (const file of files) {
                const base64 = await compressAndGetBase64(file);
                compressedBase64Images.push(base64);
                
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `<img src="${base64}" alt="preview">`;
                imagePreview.appendChild(div);
            }
        });

        async function compressAndGetBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_SIDE = 1200; // TÄƒng kÃ­ch thÆ°á»›c Ä‘á»ƒ áº£nh sáº¯c nÃ©t hÆ¡n
                        if (width > height) {
                            if (width > MAX_SIDE) { height *= MAX_SIDE / width; width = MAX_SIDE; }
                        } else {
                            if (height > MAX_SIDE) { width *= MAX_SIDE / height; height = MAX_SIDE; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // TÄƒng cháº¥t lÆ°á»£ng nÃ©n lÃªn Ä‘á»ƒ Ä‘áº¡t khoáº£ng 200KB
                        let quality = 0.8; 
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        adForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (compressedBase64Images.length === 0) {
                showToast('Vui lÃ²ng chá»n Ã­t nháº¥t 1 áº£nh', 'error');
                return;
            }

            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                const adsRef = db.ref('advertisements');
                
                // 1. Quáº£n lÃ½ giá»›i háº¡n 10 tin
                const snapshot = await adsRef.orderByChild('createdAt').once('value');
                let ads = [];
                snapshot.forEach((child) => {
                    ads.push({ key: child.key, ...child.val() });
                });

                if (ads.length >= 10) {
                    const oldestAd = ads[0];
                    await db.ref('advertisements/' + oldestAd.key).remove();
                }

                // 2. LÆ°u trá»±c tiáº¿p chuá»—i Base64 vÃ o Database (Bá» qua Storage Ä‘á»ƒ trÃ¡nh lá»—i CORS)
                await adsRef.push({
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    imageUrls: compressedBase64Images, // Giá» lÃ  máº£ng cÃ¡c chuá»—i Base64
                    createdAt: Date.now()
                });

                showToast('ÄÄƒng thÃ nh cÃ´ng!', 'success');
                setTimeout(() => window.location.href = 'index.html', 1500);

            } catch (error) {
                console.error("Lá»—i:", error);
                alert("Lá»–I Há»† THá»NG:\n" + error.message);
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        });

        function showToast(message, type) {
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 3000);
        }
    </script>
</body>
</html>
